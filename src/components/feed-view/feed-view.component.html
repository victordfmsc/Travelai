<div class="p-4 pt-6 space-y-5">
  <div class="flex flex-wrap gap-y-2 items-center justify-between">
    <h1 class="text-3xl font-bold text-gray-800">Mis Viajes</h1>
    <button (click)="toggleSort()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors">
      <span>Ordenar Presupuesto</span>
      @if (sortState() === 'asc') {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
        </svg>
      } @else if (sortState() === 'desc') {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
      } @else {
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z" />
        </svg>
      }
    </button>
  </div>
  
  @if (isLoading() && trips().length === 0) {
    <!-- Skeleton screen for initial loading -->
    @for (_ of [1, 2]; track $index) {
      <div class="bg-white rounded-xl shadow-lg overflow-hidden animate-pulse">
        <div class="w-full h-48 bg-gray-200"></div>
        <div class="p-5">
          <div class="h-8 bg-gray-200 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div class="space-y-2 mt-3">
            <div class="h-4 bg-gray-200 rounded"></div>
            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
          </div>
          <div class="h-6 bg-gray-200 rounded w-1/3 mt-4"></div>
        </div>
      </div>
    }
  } @else if (trips().length === 0) {
    <div class="text-center py-20 px-6 bg-white rounded-lg shadow">
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
      </svg>
      <h2 class="mt-4 text-xl font-semibold text-gray-700">No hay viajes todav√≠a</h2>
      <p class="mt-2 text-gray-500">¬°Crea tu primera aventura usando el bot√≥n '+' de abajo!</p>
    </div>
  } @else {
    @if (isLoading() && !selectedTrip()) {
       <!-- Skeleton for new trip being added -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden animate-pulse">
        <div class="w-full h-48 bg-gray-200"></div>
        <div class="p-5">
          <div class="h-8 bg-gray-200 rounded w-3/4 mb-2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div class="space-y-2 mt-3">
            <div class="h-4 bg-gray-200 rounded"></div>
            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
          </div>
          <div class="h-6 bg-gray-200 rounded w-1/3 mt-4"></div>
        </div>
      </div>
    }
    @for (trip of sortedTrips(); track trip.id) {
      <div 
        [id]="'trip-' + trip.id"
        class="bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl"
        [class.ring-4]="trip.id === mapSelectedTripId()"
        [class.ring-blue-500]="trip.id === mapSelectedTripId()"
        [class.ring-offset-2]="trip.id === mapSelectedTripId()">
        
        <img [src]="trip.imageUrl" alt="Paisaje de {{trip.ubicacion}}" class="w-full h-48 object-cover">
        
        <div class="p-5">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">{{ trip.titulo }}</h2>
              <p class="text-sm font-medium text-blue-600">{{ trip.ubicacion }}</p>
            </div>
            <span class="text-xs font-semibold uppercase px-3 py-1 rounded-full"
              [class.bg-green-100]="trip.presupuesto === 'Bajo'"
              [class.text-green-800]="trip.presupuesto === 'Bajo'"
              [class.bg-yellow-100]="trip.presupuesto === 'Medio'"
              [class.text-yellow-800]="trip.presupuesto === 'Medio'"
              [class.bg-red-100]="trip.presupuesto === 'Alto'"
              [class.text-red-800]="trip.presupuesto === 'Alto'">
              {{ trip.presupuesto }}
            </span>
          </div>
          
          <p class="text-gray-600 mt-3 text-sm">{{ trip.descripcion }}</p>

          <div class="mt-4 flex items-center justify-between">
            <button (click)="selectTrip(trip)" class="text-blue-600 font-semibold text-sm hover:underline">
              {{ selectedTrip() === trip ? 'Ocultar Itinerario' : 'Ver Itinerario Completo' }}
            </button>
            <div class="flex items-center space-x-2">
               <button (click)="onEditTrip(trip)" class="flex items-center space-x-1.5 text-gray-500 hover:text-gray-800 transition-colors p-2 -m-2 rounded-lg hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" />
                </svg>
                <span class="text-sm font-semibold">Editar</span>
              </button>
              <button (click)="shareTrip(trip)" class="flex items-center space-x-1.5 text-gray-500 hover:text-gray-800 transition-colors p-2 -m-2 rounded-lg hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                </svg>
                <span class="text-sm font-semibold">Compartir</span>
              </button>
            </div>
          </div>
        </div>

        @if (selectedTrip() === trip) {
          <div class="px-5 pb-5 bg-gray-50 border-t">
            <div class="flex justify-end pt-4">
               <button (click)="openActivityMap(trip)" class="bg-blue-600 text-white font-semibold text-sm px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow hover:shadow-md">
                Ver Actividades en Mapa
               </button>
            </div>
            @for (day of trip.plan; track day.dia) {
              <div class="mt-4">
                <h4 class="font-bold text-gray-800">{{ day.titulo_dia }} (D√≠a {{ day.dia }})</h4>
                <ul class="list-disc list-inside mt-2 space-y-1 text-sm text-gray-700">
                  @for (activity of day.actividades; track activity.nombre) {
                    <li>{{ activity.emoji }} {{ activity.nombre }}</li>
                  }
                </ul>

                @if (day.restaurantes && day.restaurantes.length > 0) {
                  <div class="mt-3 pl-5 border-l-2 border-gray-200">
                    <h5 class="font-semibold text-sm text-gray-600 flex items-center">
                      <span class="mr-1.5">üç¥</span>
                      Sugerencias para comer
                    </h5>
                    <ul class="mt-2 space-y-2 text-sm text-gray-700">
                      @for (restaurante of day.restaurantes; track restaurante.nombre) {
                        <li class="flex items-start">
                          <span class="mr-2 text-lg">üçΩÔ∏è</span>
                          <div>
                            <span class="font-medium">{{ restaurante.nombre }}</span>
                            <span class="text-gray-500"> - {{ restaurante.tipo_cocina }}</span>
                            @if (restaurante.mapa_url) {
                              <a [href]="restaurante.mapa_url" target="_blank" rel="noopener noreferrer" class="ml-2 text-blue-600 hover:text-blue-800 hover:underline text-xs font-semibold">(Ver mapa)</a>
                            }
                          </div>
                        </li>
                      }
                    </ul>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  }
</div>

@if (showActivityMapForTrip(); as trip) {
  <app-activity-map [trip]="trip" (close)="closeActivityMap()" />
}
